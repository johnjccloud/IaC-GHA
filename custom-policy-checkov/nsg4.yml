---
metadata:
  name: "Disallow High Risk Ports from Internal"
  id: "CKV_CUSTOM_4"
  category: "Infrastructure as Code"
  severity: "CRITICAL"
definition:
 not:
    and:
          - cond_type: "attribute"
            resource_types:
              - "azurerm_network_security_rule"
            attribute: "direction"
            operator: "equals"
            value: "Inbound"
          - cond_type: "attribute"
            resource_types:
              - "azurerm_network_security_rule"
            attribute: "access"
            operator: "equals"
            value: "Allow"
          - cond_type: "attribute"
            resource_types:
              - "azurerm_network_security_rule"
            attribute: "source_address_prefix"
            operator: "equals"
            value: "VirtualNetwork"            
          - or:
              - cond_type: "attribute"
                resource_types:
                  - "azurerm_network_security_rule"
                attribute: "destination_port_range"
                operator: "equals"
                value: "3389"    
              - cond_type: "attribute"
                resource_types:
                  - "azurerm_network_security_rule"
                attribute: "destination_port_range"
                operator: "equals"
                value: "22"    
              - cond_type: "attribute"
                resource_types:
                  - "azurerm_network_security_rule"
                attribute: "destination_port_range"
                operator: "equals"
                value: "445"    