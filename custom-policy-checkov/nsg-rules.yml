---
metadata:
  name: "Disallow High Risk Ports - NSG Rules"
  id: "CKV_CUSTOM_2"
  category: "Infrastructure as Code"
  severity: "CRITICAL"
definition:
    and:
          - cond_type: "attribute"
            resource_types:
              - "azurerm_network_security_rule"
            attribute: "direction"
            operator: "equals"
            value: "Inbound"
          - cond_type: "attribute"
            resource_types:
              - "azurerm_network_security_rule"
            attribute: "access"
            operator: "equals"
            value: "Allow"
          - cond_type: "attribute"
            resource_types:
              - "azurerm_network_security_rule"
            attribute: "source_address_prefix"
            operator: "not_within"
            value: 
             - "Internet"
             - "VirtualNetwork"
             - "*"
          - cond_type: "attribute"
            resource_types:
              - "azurerm_network_security_rule"
            attribute: "destination_port_range"
            operator: "within"
            value: 
             - "3389"
             - "22"
             - "*"